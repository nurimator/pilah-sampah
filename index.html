<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
    <title>Game Pilah Sampah</title>
    <style>
        /* Gaya dasar untuk body dan container game */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f0f0;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden; /* Mencegah scroll */
            /* Disable text selection and callouts on mobile */
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            /* Prevent zoom on mobile */
            touch-action: manipulation;
        }

        /* Container untuk kanvas game (75% tinggi layar) */
        .game-canvas-container {
            position: relative; /* Diperlukan untuk positioning tombol pause */
            width: 100%;
            height: 75vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #fff;
            border-bottom: 2px solid #ccc;
        }

        /* Gaya untuk kanvas game */
        #gameCanvas {
            border-radius: 10px;
            background-color: #a4d2e1; /* Warna air sungai */
            border: 5px solid #6b4d3e; /* Warna daratan/tepi sungai */
            box-sizing: border-box;
            width: 90%;
            height: 95%;
            cursor: pointer;
            /* Touch optimization */
            touch-action: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Container untuk UI di bagian bawah (25% tinggi layar) */
        .bottom-ui-container {
            width: 100%;
            height: 25vh;
            background-color: #fafafa;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 10px 20px;
            box-sizing: border-box;
        }

        /* Gaya untuk panel UI di bagian bawah */
        .ui-panel {
            display: flex;
            flex-direction: row;
            justify-content: space-between; /* Memisahkan 3 panel secara merata */
            align-items: flex-start;
            width: 100%;
            height: 100%;
        }

        .stats-container, .actions-container, .bins-container {
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 10px;
            height: 90%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.05);
            margin: 0 10px;
            flex: 1; /* Agar setiap panel mengisi ruang secara merata */
        }
        
        /* Penyesuaian lebar panel */
        .stats-container { max-width: 30%; }
        .bins-container { max-width: 35%; }
        .actions-container { max-width: 30%; }

        .ui-panel h2 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #333;
            text-align: center;
            font-size: 1.2em;
        }

        .stat-item {
            font-size: 0.9em; /* Ukuran font diperkecil agar muat */
            margin-bottom: 4px;
            padding: 4px;
            background-color: #f9f9f9;
            border-radius: 5px;
            border-left: 3px solid #007bff;
            width: 100%;
            box-sizing: border-box;
        }
        
        .stat-item.money { border-color: #28a745; }
        .stat-item.durability { border-color: #ffc107; }
        .stat-item.grab-level { border-color: #9c27b0; } /* Warna untuk level grab */

        .actions-container {
            gap: 10px;
        }

        .actions-container button, #sellBtn {
            width: 100%;
            padding: 8px 10px;
            margin-bottom: 5px;
            font-size: 1.2em; /* Tombol lebih besar */
            height: 45%;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            color: #fff;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            /* Mobile touch optimization */
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .actions-container button:hover:not(:disabled), #sellBtn:hover:not(:disabled),
        .actions-container button:active:not(:disabled), #sellBtn:active:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
        }
        
        .actions-container button:disabled, #sellBtn:disabled {
            background-color: #9e9e9e;
            cursor: not-allowed;
        }

        #shopBtn { background-color: #007bff; }
        #inventoryBtn { background-color: #6f42c1; }
        .btn-sell { background-color: #28a745; }

        /* Pengaturan baru untuk container keranjang sampah */
        .bins-container {
            flex-direction: column; /* Tong sampah dan tombol jual disusun vertikal */
            justify-content: center;
            align-items: center;
            gap: 10px; 
            height: 100%;
        }
        
        .bin-wrapper {
            display: flex;
            gap: 20px;
            width: 100%;
            height: 75%;
            justify-content: center;
        }

        .bin-button {
            height: 100%; /* Memenuhi tinggi wrapper */
            aspect-ratio: 4 / 5; /* Menjaga rasio lebar:tinggi */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin: 0;
            font-size: 1.3em;
            border: none;
            border-radius: 12px;
            color: #fff;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            /* Mobile touch optimization */
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .bin-button:hover, .bin-button:active {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
        }

        .bin-organik { background-color: #4caf50; }
        .bin-anorganik { background-color: #795548; }

        .bin-button.highlight {
            box-shadow: 0 0 15px 5px rgba(255, 215, 0, 0.9); /* Efek highlight lebih jelas */
            transform: scale(1.1);
        }
        
        #sellBtn {
            width: 80%;
            margin-top: 5px;
        }

        /* Elemen sampah yang diseret */
        .dragged-trash-ghost {
            position: absolute;
            width: 50px;
            height: 50px;
            border-radius: 4px;
            pointer-events: none;
            z-index: 9999;
            color: white;
            font-weight: bold;
            font-size: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
            text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
            /* Mobile optimization */
            touch-action: none;
        }

        /* Mobile-specific improvements */
        @media (hover: none) and (pointer: coarse) {
            .bin-button:hover {
                transform: none;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            }
            
            .actions-container button:hover:not(:disabled), #sellBtn:hover:not(:disabled) {
                transform: none;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            }
            
            /* Use :active for touch feedback instead */
            .bin-button:active {
                transform: scale(0.95);
            }
            
            .actions-container button:active:not(:disabled), #sellBtn:active:not(:disabled) {
                transform: scale(0.95);
            }
            
            .catalog-button:active:not(:disabled) {
                transform: scale(0.95);
            }
        }

        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .overlay-box {
            background-color: #fff;
            padding: 20px 40px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            gap: 15px;
            min-width: 500px; /* Diperlebar untuk katalog */
            max-height: 80vh;
            overflow-y: auto;
        }

        .overlay-box h1 {
            margin-top: 0;
            color: #333;
        }
        
        .overlay-box .game-over-title { color: #dc3545; }

        .overlay-box button {
            padding: 12px 25px;
            font-size: 1.1em;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            color: #fff;
            font-weight: bold;
            transition: background-color 0.2s;
            /* Mobile touch optimization */
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            min-height: 44px; /* Minimum touch target size */
        }

        #resumeBtn, .btn-close-overlay { background-color: #28a745; }
        #resumeBtn:hover, .btn-close-overlay:hover { background-color: #218838; }
        
        #restartBtn { background-color: #007bff; }
        #restartBtn:hover { background-color: #0056b3; }
        
        .btn-placeholder {
            background-color: #9e9e9e;
            cursor: not-allowed;
        }
        
        #pauseBtn {
            position: absolute;
            top: 20px;
            right: 30px;
            width: 50px;
            height: 50px;
            font-size: 24px;
            font-weight: bold;
            color: #fff;
            background-color: rgba(0, 0, 0, 0.5);
            border: 2px solid #fff;
            border-radius: 50%;
            cursor: pointer;
            z-index: 50;
            transition: background-color 0.3s;
        }
        #pauseBtn:hover {
            background-color: rgba(0, 0, 0, 0.8);
        }
        
        #megaNetBtn {
            position: absolute;
            bottom: 20px;
            right: 30px;
            width: 60px;
            height: 60px;
            font-size: 20px;
            font-weight: bold;
            color: #fff;
            background-color: #dc3545;
            border: 2px solid #fff;
            border-radius: 50%;
            cursor: pointer;
            z-index: 50;
            transition: all 0.3s;
            display: none; /* Sembunyi sampai dibeli */
        }
        #megaNetBtn:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        
        .message-box {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0,0,0,0.8);
            color: #fff;
            padding: 12px 24px;
            border-radius: 20px;
            opacity: 0;
            transition: opacity 0.5s ease-in-out, top 0.5s ease-in-out;
            z-index: 200;
        }

        .message-box.show {
            opacity: 1;
            top: 30px;
        }
        
        /* Gaya Katalog */
        .catalog-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            width: 100%;
        }
        .catalog-item {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        .catalog-icon {
            width: 80px;
            height: 80px;
            background-color: #e9ecef;
            border-radius: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 3em;
            color: #adb5bd;
        }
        .catalog-item h3 {
            margin: 5px 0;
            font-size: 1.1em;
        }
        .catalog-button-group {
            display: flex;
            gap: 5px;
            width: 100%;
        }
        .catalog-button-group button {
            flex: 1;
            padding: 8px 5px !important;
            font-size: 0.8em !important;
            /* Mobile touch optimization */
            min-height: 36px;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        .btn-buy { background-color: #28a745; }
        .btn-repair { background-color: #ffc107; color: #000 !important; }
        .btn-upgrade { background-color: #9c27b0; }
        .btn-buy:disabled, .btn-repair:disabled, .btn-upgrade:disabled {
            background-color: #9e9e9e !important;
            cursor: not-allowed;
        }

        .inventory-sell-btn {
            padding: 5px 10px !important;
            font-size: 0.9em !important;
            background-color: #28a745;
            width: 100%;
            /* Mobile touch optimization */
            min-height: 36px;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        .inventory-sell-btn:disabled {
            background-color: #9e9e9e !important;
        }

        /* Mobile Responsive Design */
        @media (max-width: 768px) {
            .ui-panel {
                flex-direction: column;
                gap: 10px;
            }

            .stats-container, .actions-container, .bins-container {
                max-width: 100%;
                width: 100%;
                height: auto;
                min-height: 80px;
                margin: 0;
            }

            .stats-container {
                order: 1;
                padding: 8px;
            }

            .bins-container {
                order: 2;
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                padding: 8px;
            }

            .bin-wrapper {
                height: auto;
                flex: 1;
                max-width: 60%;
            }

            .bin-button {
                height: 60px;
                font-size: 1em;
                aspect-ratio: auto;
            }

            #sellBtn {
                width: 35%;
                height: 60px;
                margin: 0;
                font-size: 0.9em;
            }

            .actions-container {
                order: 3;
                flex-direction: row;
                gap: 10px;
                padding: 8px;
            }

            .actions-container button {
                height: 50px;
                font-size: 1em;
                margin-bottom: 0;
            }

            .stat-item {
                font-size: 0.8em;
                margin-bottom: 2px;
                padding: 3px;
            }

            .ui-panel h2 {
                font-size: 1em;
                margin-bottom: 5px;
            }

            #pauseBtn, #megaNetBtn {
                width: 40px;
                height: 40px;
                font-size: 18px;
            }

            .overlay-box {
                min-width: 90%;
                max-width: 95%;
                padding: 15px 20px;
                margin: 10px;
            }

            .catalog-container {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .catalog-item {
                padding: 8px;
            }

            .catalog-icon {
                width: 60px;
                height: 60px;
                font-size: 2.5em;
            }

            .catalog-item h3 {
                font-size: 0.9em;
            }

            .message-box {
                font-size: 0.9em;
                padding: 8px 16px;
                left: 50%;
                right: auto;
                transform: translateX(-50%);
                max-width: 90%;
                text-align: center;
            }
        }

        @media (max-width: 480px) {
            .bottom-ui-container {
                height: 30vh;
                padding: 5px 10px;
            }

            .game-canvas-container {
                height: 70vh;
            }

            .bin-button {
                font-size: 0.9em;
                height: 50px;
            }

            #sellBtn {
                font-size: 0.8em;
                height: 50px;
            }

            .actions-container button {
                font-size: 0.9em;
                height: 45px;
            }

            .stat-item {
                font-size: 0.7em;
            }

            .catalog-container {
                grid-template-columns: 1fr;
            }

            .overlay-box {
                min-width: 95%;
                padding: 10px 15px;
            }
        }

        /* Extra small devices (portrait phones) */
        @media (max-width: 360px) {
            .ui-panel h2 {
                font-size: 0.9em;
            }
            
            .stat-item {
                font-size: 0.65em;
                padding: 2px;
            }
            
            .bin-button {
                font-size: 0.8em;
                height: 45px;
            }
            
            #sellBtn {
                font-size: 0.7em;
                height: 45px;
            }
            
            .actions-container button {
                font-size: 0.8em;
                height: 40px;
            }
        }

    </style>
</head>
<body>

    <div class="game-canvas-container">
        <canvas id="gameCanvas"></canvas>
        <button id="pauseBtn">||</button>
        <button id="megaNetBtn">NET</button>
    </div>

    <!-- Container untuk ghost, tidak perlu di style karena isinya absolute -->
    <div id="draggedStackContainer"></div>

    <div class="bottom-ui-container">
        <div class="ui-panel">
            <div class="stats-container">
                <h2>Status Game</h2>
                <div class="stat-item">Skor: <span id="score">0</span></div>
                <div class="stat-item money">Uang: Rp <span id="money">0</span></div>
                <div class="stat-item">Sampah Terlewat: <span id="lewat">0</span> / 10</div>
                <div class="stat-item durability" id="trapDurabilityContainer">Level Perangkap: -</div>
                <div class="stat-item">Kecepatan Sampah: <span id="trashSpeed">1.0</span>x</div>
                <div class="stat-item grab-level">Multi Grab: x<span id="multiGrabLimit">1</span></div>
            </div>

            <!-- Kontainer keranjang sampah baru -->
            <div class="bins-container">
                <div class="bin-wrapper">
                    <button class="bin-button bin-organik" id="bin-organik">Organik</button>
                    <button class="bin-button bin-anorganik" id="bin-anorganik">Anorganik</button>
                </div>
                <button class="btn-sell" id="sellBtn">Jual Sampah (Rp 0)</button>
            </div>
            
            <div class="actions-container">
                <button id="shopBtn">Shop</button>
                <button id="inventoryBtn">Inventory</button>
            </div>
        </div>
    </div>

    <!-- Message Box -->
    <div id="messageBox" class="message-box"></div>

    <!-- Game Over Overlay -->
    <div class="overlay" id="gameOverOverlay">
        <div class="overlay-box">
            <h1 class="game-over-title">GAME OVER!</h1>
            <p>10 sampah telah terlewat.</p>
            <p>Skor Akhir: <span id="finalScore">0</span></p>
            <button id="restartBtn">Mulai Ulang</button>
        </div>
    </div>
    
    <!-- Pause Menu Overlay -->
    <div class="overlay" id="pauseMenuOverlay">
        <div class="overlay-box">
            <h1>Game Dijeda</h1>
            <button id="resumeBtn">Lanjutkan</button>
            <button class="btn-placeholder" disabled>Coming Soon</button>
            <button class="btn-placeholder" disabled>Coming Soon</button>
        </div>
    </div>
    
    <!-- Shop Menu Overlay -->
    <div class="overlay" id="shopOverlay">
        <div class="overlay-box">
            <h1>Toko</h1>
            <div class="catalog-container" id="shopContent">
                <!-- Konten toko akan digenerate oleh JS -->
            </div>
            <hr style="width:100%; border-top: 1px solid #ccc;">
            <div class="catalog-container" id="shopToolsContent">
                <!-- Konten alat akan digenerate oleh JS -->
            </div>
            <button class="btn-close-overlay" id="closeShopBtn">Tutup</button>
        </div>
    </div>
    
    <!-- Inventory Menu Overlay -->
    <div class="overlay" id="inventoryOverlay">
        <div class="overlay-box">
            <h1>Inventory</h1>
            <div class="catalog-container" id="inventoryContent">
                <!-- Konten inventory akan digenerate oleh JS -->
            </div>
            <button class="btn-close-overlay" id="closeInventoryBtn">Tutup</button>
        </div>
    </div>


    <script>
        // Mendapatkan elemen canvas dan konteks 2D
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let animationFrameId;

        // Fungsi baru untuk menghitung harga
        function getNewUpgradeCost(level, basePrice) {
            const n = level; // n adalah level yang dituju
            const b = 2; // konstanta eksponensial
            if (n <= 0) return basePrice;
            const cost = basePrice * n * Math.pow(Math.log(n + 1), b);
            return Math.round(cost / 10) * 10; // Bulatkan ke 10 terdekat
        }

        // Detect if device is mobile
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                   (window.innerWidth <= 768 && 'ontouchstart' in window);
        }

        // Adjust game settings for mobile
        function adjustForMobile() {
            if (isMobileDevice()) {
                // Slightly larger touch targets on mobile
                config.trashSpawnInterval = 1800; // Slightly slower spawn rate
                // Show touch instructions
                showMessage("Sentuh dan seret sampah ke keranjang yang tepat!", 4000);
            }
        }

        // Definisi variabel game
        let gameState = {
            score: 0,
            money: 0,
            trashPassed: 0,
            isGameOver: false,
            isPaused: false,
            trashOnScreen: [],
            traps: {
                left:   { name: 'Kiri', owned: false, level: 0, price: 100 },
                center: { name: 'Tengah', owned: false, level: 0, price: 300 },
                right:  { name: 'Kanan', owned: false, level: 0, price: 100 }
            },
            tools: {
                multiGrabber: { name: 'Multi Grabber', owned: false, level: 0, price: 100 },
                trapSweeper:  { name: 'Trap Sweeper', owned: false, level: 0, price: 300, position: 0, direction: 1, lastSweep: 0, attachedTrash: [] },
                megaNet:      { name: 'Mega Net', owned: false, level: 0, price: 500, cooldown: 30, lastUsed: 0 }
            },
            trashSpeedMultiplier: 1.0,
            selectedTrashStack: [],
            selectedTrashStackGhosts: [], // Untuk visual drag
            isDragging: false,
            isUsingMegaNet: false,
            megaNetStartPos: null,
            collectedTrash: {
                organik: [], plastikP: [], plastikQ: [], plastikR: [], kertas: [], kaca: [], logamL: [], logamM: [], logamN: []
            },
            inventory: {
                specialX: 0,
                specialY: 0,
                specialZ: 0
            },
        };

        // Data karakteristik sampah baru
        const TRASH_TYPES = {
            organik: { jenis: 'organik', kategori: 'organik', harga_per_kg: 20, berat_kg: 0.2, color: '#8bc34a', char: 'O' },
            plastikP: { jenis: 'plastikP', kategori: 'anorganik', harga_per_kg: 50, berat_kg: 0.1, color: '#ff5722', char: 'P' },
            plastikQ: { jenis: 'plastikQ', kategori: 'anorganik', harga_per_kg: 60, berat_kg: 0.15, color: '#f44336', char: 'Q' },
            plastikR: { jenis: 'plastikR', kategori: 'anorganik', harga_per_kg: 75, berat_kg: 0.2, color: '#e91e63', char: 'R' },
            kertas: { jenis: 'kertas', kategori: 'anorganik', harga_per_kg: 30, berat_kg: 0.05, color: '#2196f3', char: 'K' },
            kaca: { jenis: 'kaca', kategori: 'anorganik', harga_per_kg: 40, berat_kg: 0.7, color: '#e0e0e0', char: 'G' },
            logamL: { jenis: 'logamL', kategori: 'anorganik', harga_per_kg: 100, berat_kg: 0.5, color: '#607d8b', char: 'L' },
            logamM: { jenis: 'logamM', kategori: 'anorganik', harga_per_kg: 120, berat_kg: 0.8, color: '#546e7a', char: 'M' },
            logamN: { jenis: 'logamN', kategori: 'anorganik', harga_per_kg: 150, berat_kg: 1.2, color: '#455a64', char: 'N' },
            specialX: { jenis: 'specialX', kategori: 'special', name: 'Bebek Karet', sellPrice: 100, color: '#ffc107', char: 'X' },
            specialY: { jenis: 'specialY', kategori: 'special', name: 'Boneka Teddy', sellPrice: 250, color: '#ffc107', char: 'Y' },
            specialZ: { jenis: 'specialZ', kategori: 'special', name: 'Botol Pesan', sellPrice: 0, color: '#ffc107', char: 'Z' }
        };

        const config = {
            trashSpawnInterval: 1500,
            trashBaseSpeed: 1.2,
            sweeperInterval: 5000, // 5 detik
            sweeperSpeed: 5,
        };

        let lastTrashSpawnTime = 0;
        let trapPlacementHitboxes = {};
        let mousePos = { x: 0, y: 0 };

        // Mendapatkan elemen UI
        const scoreEl = document.getElementById('score');
        const moneyEl = document.getElementById('money');
        const lewatEl = document.getElementById('lewat');
        const trapDurabilityContainer = document.getElementById('trapDurabilityContainer');
        const trashSpeedEl = document.getElementById('trashSpeed');
        const sellBtn = document.getElementById('sellBtn');
        const gameOverOverlay = document.getElementById('gameOverOverlay');
        const finalScoreEl = document.getElementById('finalScore');
        const binButtons = {
            organik: document.getElementById('bin-organik'),
            anorganik: document.getElementById('bin-anorganik')
        };
        const messageBox = document.getElementById('messageBox');
        const draggedStackContainer = document.getElementById('draggedStackContainer');
        const multiGrabLimitEl = document.getElementById('multiGrabLimit');
        const pauseBtn = document.getElementById('pauseBtn');
        const pauseMenuOverlay = document.getElementById('pauseMenuOverlay');
        const resumeBtn = document.getElementById('resumeBtn');
        const restartBtn = document.getElementById('restartBtn');
        const shopBtn = document.getElementById('shopBtn');
        const inventoryBtn = document.getElementById('inventoryBtn');
        // Elemen Toko
        const shopOverlay = document.getElementById('shopOverlay');
        const shopContent = document.getElementById('shopContent');
        const shopToolsContent = document.getElementById('shopToolsContent');
        const closeShopBtn = document.getElementById('closeShopBtn');
        // Elemen Inventory
        const inventoryOverlay = document.getElementById('inventoryOverlay');
        const inventoryContent = document.getElementById('inventoryContent');
        const closeInventoryBtn = document.getElementById('closeInventoryBtn');
        // Tombol Skill
        const megaNetBtn = document.getElementById('megaNetBtn');


        // Class untuk objek sampah
        class Sampah {
            constructor(type, x, y) {
                this.type = type;
                this.x = x;
                this.y = y;
                this.width = 50;
                this.height = 50;
                this.baseSpeed = config.trashBaseSpeed;
                this.color = this.type.color;
                this.id = Math.random();
                this.isVisible = true;
            }
            draw() {
                if (!this.isVisible) return;
                ctx.fillStyle = this.color;
                ctx.fillRect(this.x, this.y, this.width, this.height);
                let char = this.type.char;
                let textColor = '#fff';
                if (['kaca', 'specialX', 'specialY', 'specialZ'].includes(this.type.jenis)) textColor = '#000';
                ctx.fillStyle = textColor;
                ctx.font = 'bold 24px Segoe UI';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(char, this.x + this.width / 2, this.y + this.height / 2 + 2);
            }
            update() {
                const scorePercent = gameState.score / 100 * 0.1;
                let trapSlowdownPercent = 0;
                const trapY = canvas.height * 0.6;
                if (this.y + this.height >= trapY && this.y < trapY + 15) {
                    const trashCenterX = this.x + this.width / 2;
                    for (const part in trapPlacementHitboxes) {
                        const hitbox = trapPlacementHitboxes[part];
                        const trap = gameState.traps[part];
                        if (trap.owned && trashCenterX >= hitbox.x && trashCenterX < hitbox.x + hitbox.width) {
                            trapSlowdownPercent = 1 + (trap.level - 1) * 0.5;
                            break;
                        }
                    }
                }
                const finalMultiplier = 1 + scorePercent - trapSlowdownPercent;
                this.y += this.baseSpeed * Math.max(0, finalMultiplier);
            }
        }

        function showMessage(message, duration = 3000) {
            messageBox.innerText = message;
            messageBox.classList.add('show');
            
            // Add haptic feedback on mobile if available
            if (isMobileDevice() && navigator.vibrate) {
                navigator.vibrate(50); // Short vibration
            }
            
            setTimeout(() => { messageBox.classList.remove('show'); }, duration);
        }

        function defineTrapPlacementHitboxes() {
            const riverWidth = canvas.width / 2;
            const riverStartX = (canvas.width - riverWidth) / 2;
            const trapY = canvas.height * 0.6;
            const segmentWidth = riverWidth / 3;
            trapPlacementHitboxes = {
                left:   { x: riverStartX, y: trapY, width: segmentWidth, height: 15 },
                center: { x: riverStartX + segmentWidth, y: trapY, width: segmentWidth, height: 15 },
                right:  { x: riverStartX + (segmentWidth * 2), y: trapY, width: segmentWidth, height: 15 }
            };
        }

        function resizeCanvas() {
            const container = canvas.parentElement;
            canvas.width = container.clientWidth * 0.9;
            canvas.height = container.clientHeight * 0.95;
            defineTrapPlacementHitboxes();
        }
        window.addEventListener('resize', resizeCanvas);
        
        function drawPlusButton(x, y, width, height) {
            ctx.fillStyle = 'rgba(40, 167, 69, 0.8)';
            ctx.fillRect(x, y, width, height);
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 24px Segoe UI';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('+', x + width / 2, y + height / 2);
        }
        
        function drawTrapsAndButtons() {
            for (const part in gameState.traps) {
                const trap = gameState.traps[part];
                if (trap.owned) {
                    const hitbox = trapPlacementHitboxes[part];
                    ctx.fillStyle = `rgba(100, 100, 255, ${0.2 + trap.level * 0.2})`;
                    ctx.fillRect(hitbox.x, hitbox.y, hitbox.width, hitbox.height);
                }
            }
            const trapY = canvas.height * 0.6;
            const buttonWidth = 40;
            const buttonHeight = 25;
            const margin = 5;
            const riverStartX = trapPlacementHitboxes.left.x;
            const riverEndX = trapPlacementHitboxes.right.x + trapPlacementHitboxes.right.width;
            if (!gameState.traps.left.owned) drawPlusButton(riverStartX - buttonWidth - margin, trapY, buttonWidth, buttonHeight);
            if (!gameState.traps.right.owned) drawPlusButton(riverEndX + margin, trapY, buttonWidth, buttonHeight);
            if (gameState.traps.left.owned && gameState.traps.right.owned && !gameState.traps.center.owned) {
                const centerHitbox = trapPlacementHitboxes.center;
                drawPlusButton(centerHitbox.x + centerHitbox.width / 2 - buttonWidth / 2, trapY, buttonWidth, buttonHeight);
            }
        }

        function drawSweeper() {
            if (!gameState.tools.trapSweeper.owned) return;
            const sweeper = gameState.tools.trapSweeper;
            
            ctx.fillStyle = 'rgba(255, 0, 255, 0.7)';
            ctx.fillRect(sweeper.position - 10, canvas.height * 0.6 - 5, 20, 25);
            // Gambar sampah yang melekat
            sweeper.attachedTrash.forEach((trash, index) => {
                trash.x = sweeper.position - trash.width/2;
                trash.y = canvas.height * 0.6 - 5 - ((index + 1) * 10);
                trash.draw();
            });
        }
        
        function drawMegaNetArea() {
            if (!gameState.isUsingMegaNet) return;
            ctx.beginPath();
            ctx.arc(mousePos.x, mousePos.y, 250, 0, Math.PI * 2);
            ctx.strokeStyle = 'rgba(255, 20, 20, 0.7)';
            ctx.lineWidth = 5;
            ctx.stroke();
        }

        function drawBackground() {
            ctx.fillStyle = '#6b4d3e';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            const riverWidth = canvas.width / 2;
            const riverStartX = (canvas.width - riverWidth) / 2;
            ctx.fillStyle = '#a4d2e1';
            ctx.fillRect(riverStartX, 0, riverWidth, canvas.height);
            drawTrapsAndButtons();
        }

        function update() {
            gameState.trashOnScreen.forEach(trash => trash.update());
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawBackground();
            // **PERUBAHAN**: Gambar dari yang paling baru ke paling lama
            for (let i = gameState.trashOnScreen.length - 1; i >= 0; i--) {
                gameState.trashOnScreen[i].draw();
            }
            drawSweeper();
            drawMegaNetArea();
        }
        
        function pauseGame() {
            if (gameState.isGameOver) return;
            gameState.isPaused = true;
            cancelAnimationFrame(animationFrameId);
        }
        
        function resumeGame() {
            if (gameState.isGameOver) return;
            gameState.isPaused = false;
            shopOverlay.style.display = 'none';
            pauseMenuOverlay.style.display = 'none';
            inventoryOverlay.style.display = 'none';
            animationFrameId = requestAnimationFrame(gameLoop);
        }

        function gameLoop() {
            if (gameState.isGameOver || gameState.isPaused) {
                cancelAnimationFrame(animationFrameId);
                return;
            }
            const now = Date.now();
            if (now - lastTrashSpawnTime > config.trashSpawnInterval) {
                spawnTrash();
                lastTrashSpawnTime = now;
            }
            update();
            draw();
            handleGameLogic();
            handleTools(now);
            updateUI();
            animationFrameId = requestAnimationFrame(gameLoop);
        }

        function spawnTrash() {
            const trashTypesKeys = Object.keys(TRASH_TYPES);
            let randomTypeKey;
            if (Math.random() < 0.05) {
                const specialKeys = ['specialX', 'specialY', 'specialZ'];
                randomTypeKey = specialKeys[Math.floor(Math.random() * specialKeys.length)];
            } else {
                const regularTrashKeys = trashTypesKeys.filter(k => !k.startsWith('special'));
                randomTypeKey = regularTrashKeys[Math.floor(Math.random() * regularTrashKeys.length)];
            }
            const trashType = TRASH_TYPES[randomTypeKey];
            const riverWidth = canvas.width / 2;
            const riverStartX = (canvas.width - riverWidth) / 2;
            const x = riverStartX + Math.random() * (riverWidth - 50);
            const newTrash = new Sampah(trashType, x, -60);
            gameState.trashOnScreen.push(newTrash);
        }

        function handleGameLogic() {
            gameState.trashOnScreen = gameState.trashOnScreen.filter(trash => {
                if (trash.y > canvas.height) {
                    gameState.trashPassed++;
                    return false;
                }
                return true;
            });
            if (gameState.trashPassed >= 10) {
                gameState.isGameOver = true;
                gameOverOverlay.style.display = 'flex';
                finalScoreEl.innerText = gameState.score;
                pauseGame();
            }
        }
        
        function handleTools(now) {
            // Trap Sweeper
            const sweeper = gameState.tools.trapSweeper;
            if (sweeper.owned) {
                const riverStartX = trapPlacementHitboxes.left.x;
                const riverEndX = trapPlacementHitboxes.right.x + trapPlacementHitboxes.right.width;
                sweeper.position += sweeper.direction * config.sweeperSpeed;
                const trapY = canvas.height * 0.6;
                const metalTrashOnTraps = gameState.trashOnScreen.filter(t => 
                    (t.type.jenis.startsWith('logam')) && t.y + t.height >= trapY && t.y < trapY + 15
                );
                
                metalTrashOnTraps.forEach(trash => {
                    const trashCenterX = trash.x + trash.width / 2;
                    const sweeperHitbox = { x: sweeper.position - 10, width: 20 };
                    if (sweeper.attachedTrash.length < sweeper.level && trashCenterX > sweeperHitbox.x && trashCenterX < sweeperHitbox.x + sweeperHitbox.width) {
                        sweeper.attachedTrash.push(trash);
                        gameState.trashOnScreen = gameState.trashOnScreen.filter(t => t.id !== trash.id);
                    }
                });
                if (sweeper.position > riverEndX || sweeper.position < riverStartX) {
                    sweeper.direction *= -1;
                    if (sweeper.attachedTrash.length > 0) {
                        gameState.score += sweeper.attachedTrash.length * 10;
                        sweeper.attachedTrash.forEach(trash => {
                            gameState.collectedTrash[trash.type.jenis].push(trash);
                        });
                        showMessage(`Sweeper mengumpulkan ${sweeper.attachedTrash.length} logam!`);
                        sweeper.attachedTrash = [];
                    }
                }
            }

            // Mega Net Cooldown
            const megaNet = gameState.tools.megaNet;
            if (megaNet.owned) {
                const timeSinceUsed = (now - megaNet.lastUsed) / 1000;
                if (timeSinceUsed >= megaNet.cooldown) {
                    megaNetBtn.disabled = false;
                    megaNetBtn.innerText = "NET";
                } else {
                    megaNetBtn.disabled = true;
                    megaNetBtn.innerText = Math.ceil(megaNet.cooldown - timeSinceUsed);
                }
            }
        }

        function updateUI() {
            scoreEl.innerText = gameState.score;
            moneyEl.innerText = gameState.money;
            lewatEl.innerText = `${gameState.trashPassed} / 10`;
            const scoreSpeedBonus = 1.0 + Math.floor(gameState.score / 100) * 0.1;
            trashSpeedEl.innerText = scoreSpeedBonus.toFixed(1) + 'x';
            let levelText = "Level Perangkap: ";
            const ownedTraps = Object.keys(gameState.traps).filter(p => gameState.traps[p].owned);
            if (ownedTraps.length > 0) {
                levelText += ownedTraps.map(p => `${p.charAt(0).toUpperCase()}: ${gameState.traps[p].level}`).join(', ');
            } else {
                levelText += "N/A";
            }
            trapDurabilityContainer.innerText = levelText;
            multiGrabLimitEl.innerText = gameState.tools.multiGrabber.owned ? gameState.tools.multiGrabber.level + 1 : 1;
            let totalSellPrice = 0;
            Object.values(gameState.collectedTrash).flat().forEach(trash => {
                totalSellPrice += trash.type.harga_per_kg * trash.type.berat_kg;
            });
            sellBtn.innerText = `Jual Sampah (Rp ${Math.round(totalSellPrice)})`;
            sellBtn.disabled = totalSellPrice === 0;
        }
        
        function getDistance(x1, y1, x2, y2) {
            const dx = x1 - x2;
            const dy = y1 - y2;
            return Math.sqrt(dx * dx + dy * dy);
        }

        function getBuyButtonHitboxes() {
            const hitboxes = {};
            const trapY = canvas.height * 0.6;
            const buttonWidth = 40;
            const buttonHeight = 25;
            const margin = 5;
            const riverStartX = trapPlacementHitboxes.left.x;
            const riverEndX = trapPlacementHitboxes.right.x + trapPlacementHitboxes.right.width;
            if (!gameState.traps.left.owned) hitboxes.left = { x: riverStartX - buttonWidth - margin, y: trapY, width: buttonWidth, height: buttonHeight };
            if (!gameState.traps.right.owned) hitboxes.right = { x: riverEndX + margin, y: trapY, width: buttonWidth, height: buttonHeight };
            if (gameState.traps.left.owned && gameState.traps.right.owned && !gameState.traps.center.owned) {
                const centerPlacement = trapPlacementHitboxes.center;
                hitboxes.center = { x: centerPlacement.x + centerPlacement.width / 2 - buttonWidth / 2, y: trapY, width: buttonWidth, height: buttonHeight };
            }
            return hitboxes;
        }

        function getEventPos(e) {
            // Handle both mouse and touch events
            if (e.touches && e.touches.length > 0) {
                return { clientX: e.touches[0].clientX, clientY: e.touches[0].clientY };
            } else if (e.changedTouches && e.changedTouches.length > 0) {
                return { clientX: e.changedTouches[0].clientX, clientY: e.changedTouches[0].clientY };
            }
            return { clientX: e.clientX, clientY: e.clientY };
        }

        function buyTrap(part) {
            const trap = gameState.traps[part];
            if (gameState.money >= trap.price && !trap.owned) {
                gameState.money -= trap.price;
                trap.owned = true;
                trap.level = 1;
                showMessage(`Perangkap ${part} berhasil dibeli!`);
            } else if (!trap.owned) {
                showMessage("Uang tidak cukup!");
            }
        }

        canvas.addEventListener('mousedown', handlePointerDown);
        canvas.addEventListener('touchstart', handlePointerDown);

        function handlePointerDown(e) {
            e.preventDefault(); // Prevent scrolling and other default behaviors
            if (gameState.isPaused || gameState.isGameOver) return;
            
            const eventPos = getEventPos(e);
            const rect = canvas.getBoundingClientRect();
            const mouseX = eventPos.clientX - rect.left;
            const mouseY = eventPos.clientY - rect.top;
            
            if (gameState.isUsingMegaNet) {
                const collected = [];
                gameState.trashOnScreen = gameState.trashOnScreen.filter(trash => {
                    if (trash.type.kategori === 'anorganik' && getDistance(mouseX, mouseY, trash.x + trash.width/2, trash.y + trash.height/2) <= 250) {
                        collected.push(trash);
                        return false;
                    }
                    return true;
                });
                if (collected.length > 0) {
                    gameState.score += collected.length * 10;
                    collected.forEach(t => gameState.collectedTrash[t.type.jenis].push(t));
                    showMessage(`Mega Net menangkap ${collected.length} sampah!`);
                }
                gameState.isUsingMegaNet = false;
                gameState.tools.megaNet.lastUsed = Date.now();
                canvas.style.cursor = 'pointer';
                return;
            }

            const buyButtons = getBuyButtonHitboxes();
            for (const part in buyButtons) {
                const hitbox = buyButtons[part];
                if (mouseX >= hitbox.x && mouseX <= hitbox.x + hitbox.width && mouseY >= hitbox.y && mouseY <= hitbox.y + hitbox.height) {
                    buyTrap(part);
                    return;
                }
            }
            if (gameState.isDragging) return;
            const grabbableTrash = [...gameState.trashOnScreen];
            // **PERUBAHAN**: Cari dari yang paling lama (paling atas secara visual)
            const clickedTrash = grabbableTrash.find(trash => 
                trash.isVisible && mouseX >= trash.x && mouseX <= trash.x + trash.width && mouseY >= trash.y && mouseY <= trash.y + trash.height
            );
            if (clickedTrash) {
                if (clickedTrash.type.kategori === 'special') {
                    gameState.inventory[clickedTrash.type.jenis]++;
                    gameState.trashOnScreen = gameState.trashOnScreen.filter(t => t.id !== clickedTrash.id);
                    showMessage(`${clickedTrash.type.name} ditambahkan ke inventory!`);
                    draw();
                    return;
                }
                gameState.isDragging = true;
                const mainTrashData = { trash: clickedTrash, originalX: clickedTrash.x, originalY: clickedTrash.y, relativeX: 0, relativeY: 0 };
                gameState.selectedTrashStack = [mainTrashData];
                clickedTrash.isVisible = false;
                
                const grabLimit = gameState.tools.multiGrabber.owned ? gameState.tools.multiGrabber.level + 1 : 1;

                const otherTrashOfSameType = grabbableTrash.filter(t =>
                    t.id !== clickedTrash.id && t.isVisible && t.type.jenis === clickedTrash.type.jenis && getDistance(mouseX, mouseY, t.x + t.width/2, t.y + t.height/2) <= 50
                );
                
                const trashToGrab = otherTrashOfSameType.slice(0, grabLimit - 1);
                trashToGrab.forEach(t => {
                    t.isVisible = false;
                    gameState.selectedTrashStack.push({ trash: t, originalX: t.x, originalY: t.y, relativeX: t.x - clickedTrash.x, relativeY: t.y - clickedTrash.y });
                });

                draggedStackContainer.innerHTML = '';
                gameState.selectedTrashStack.forEach(item => {
                    const ghost = document.createElement('div');
                    ghost.className = 'dragged-trash-ghost';
                    ghost.style.backgroundColor = item.trash.color;
                    ghost.innerText = item.trash.type.char;
                    ghost.style.color = (['kaca', 'specialX', 'specialY', 'specialZ'].includes(item.trash.type.jenis)) ? '#000' : '#fff';
                    ghost.offsetX = (item.trash.x + rect.left) - eventPos.clientX;
                    ghost.offsetY = (item.trash.y + rect.top) - eventPos.clientY;
                    ghost.style.left = `${eventPos.clientX + ghost.offsetX}px`;
                    ghost.style.top = `${eventPos.clientY + ghost.offsetY}px`;
                    draggedStackContainer.appendChild(ghost);
                    gameState.selectedTrashStackGhosts.push(ghost);
                });
                
                draw();
                document.body.style.cursor = 'grabbing';
            }
        }
        
        window.addEventListener('mousemove', handlePointerMove);
        window.addEventListener('touchmove', handlePointerMove);
        
        function handlePointerMove(e) {
            if (e.type === 'touchmove') {
                e.preventDefault(); // Prevent scrolling
            }
            
            const eventPos = getEventPos(e);
            const rect = canvas.getBoundingClientRect();
            mousePos.x = eventPos.clientX - rect.left;
            mousePos.y = eventPos.clientY - rect.top;

            if (gameState.isDragging && gameState.selectedTrashStackGhosts.length > 0) {
                gameState.selectedTrashStackGhosts.forEach(ghost => {
                    ghost.style.left = `${eventPos.clientX + ghost.offsetX}px`;
                    ghost.style.top = `${eventPos.clientY + ghost.offsetY}px`;
                });
                const firstGhostRect = gameState.selectedTrashStackGhosts[0].getBoundingClientRect();
                const elementUnderCursor = document.elementFromPoint(eventPos.clientX, eventPos.clientY);
                const isValidDropZone = elementUnderCursor && (elementUnderCursor.id === 'gameCanvas' || elementUnderCursor.classList.contains('bin-button'));

                document.body.style.cursor = isValidDropZone ? 'grabbing' : 'not-allowed';
                
                for (const type in binButtons) {
                    binButtons[type].classList.toggle('highlight', isOverlapping(firstGhostRect, binButtons[type].getBoundingClientRect()));
                }
            }
        }
        
        window.addEventListener('mouseup', handlePointerUp);
        window.addEventListener('touchend', handlePointerUp);
        
        function handlePointerUp(e) {
            if (e.type === 'touchend') {
                e.preventDefault();
            }
            
            if (!gameState.isDragging) return;
            
            const eventPos = getEventPos(e);
            
            if (gameState.selectedTrashStack.length > 0) {
                const stack = gameState.selectedTrashStack;
                const stackCategory = stack[0].trash.type.kategori;
                let droppedOnBin = false;
                const firstGhostRect = gameState.selectedTrashStackGhosts[0].getBoundingClientRect();
                for (const binCategory in binButtons) {
                    const binRect = binButtons[binCategory].getBoundingClientRect();
                    if (isOverlapping(firstGhostRect, binRect)) {
                        droppedOnBin = true;
                        if (stackCategory === binCategory) {
                            gameState.score += 10 * stack.length;
                            stack.forEach(item => gameState.collectedTrash[item.trash.type.jenis].push(item.trash));
                            showMessage(`+${stack.length} sampah dikumpulkan!`, 2000);
                        } else {
                            gameState.trashPassed += stack.length;
                            showMessage(`Salah keranjang! ${stack.length} sampah terlewat.`, 2000);
                        }
                        break; 
                    }
                }
                const canvasRect = canvas.getBoundingClientRect();
                const mouseX = eventPos.clientX - canvasRect.left;
                const mouseY = eventPos.clientY - canvasRect.top;
                const riverWidth = canvas.width / 2;
                const riverStartX = (canvas.width - riverWidth) / 2;
                const riverEndX = riverStartX + riverWidth;
                const droppedOnRiver = (mouseX >= riverStartX && mouseX <= riverEndX && mouseY >= 0 && mouseY <= canvas.height);
                if (droppedOnBin) {
                    const stackIds = new Set(stack.map(item => item.trash.id));
                    gameState.trashOnScreen = gameState.trashOnScreen.filter(t => !stackIds.has(t.id));
                } else if (droppedOnRiver) {
                    stack.forEach(item => {
                        item.trash.isVisible = true;
                        item.trash.x = Math.max(riverStartX, Math.min((mouseX + item.relativeX), riverEndX - item.trash.width));
                        item.trash.y = Math.max(0, Math.min((mouseY + item.relativeY), canvas.height - item.trash.height));
                        if (!gameState.trashOnScreen.some(t => t.id === item.trash.id)) {
                           gameState.trashOnScreen.push(item.trash);
                        }
                    });
                    showMessage(`${stack.length} sampah kembali ke sungai!`, 2000);
                } else {
                    stack.forEach(item => { 
                        item.trash.isVisible = true;
                        item.trash.x = item.originalX;
                        item.trash.y = item.originalY;
                    });
                    showMessage(`${stack.length} sampah kembali ke posisi semula!`, 2000);
                }
            }
            for (const type in binButtons) { binButtons[type].classList.remove('highlight'); }
            draggedStackContainer.innerHTML = '';
            gameState.selectedTrashStackGhosts = [];
            document.body.style.cursor = 'default';
            gameState.isDragging = false;
            gameState.selectedTrashStack = [];
            draw();
        }

        function isOverlapping(rect1, rect2) {
            return !(rect1.right < rect2.left || rect1.left > rect2.right || rect1.bottom < rect2.top || rect1.top > rect2.bottom);
        }
        
        // --- Event Listeners untuk Tombol ---
        sellBtn.addEventListener('click', () => {
            let totalMoney = 0;
            Object.values(gameState.collectedTrash).flat().forEach(trash => {
                totalMoney += trash.type.harga_per_kg * trash.type.berat_kg;
            });
            Object.keys(gameState.collectedTrash).forEach(key => {
                if (!key.startsWith('special')) gameState.collectedTrash[key] = [];
            });
            if (totalMoney > 0) {
                gameState.money += Math.round(totalMoney);
                showMessage(`Berhasil menjual sampah senilai Rp ${Math.round(totalMoney)}!`);
            }
        });
        
        function renderShop() {
            shopContent.innerHTML = '';
            shopToolsContent.innerHTML = '';
            // Render Traps
            for (const part in gameState.traps) {
                const trap = gameState.traps[part];
                const upgradeCost = getNewUpgradeCost(trap.level + 1, trap.price);
                const card = document.createElement('div');
                card.className = 'catalog-item';
                const name = `<h3>Perangkap ${trap.name}</h3>`;
                const level = `<p>Level: ${trap.level}</p>`;
                let buttons = '';
                if (trap.owned) {
                    buttons = `<button class="catalog-button btn-upgrade" data-part="${part}" ${gameState.money < upgradeCost ? 'disabled' : ''}>Upgrade (Rp ${upgradeCost})</button>`;
                } else {
                    buttons = `<button class="catalog-button btn-buy" data-part="${part}" ${gameState.money < trap.price ? 'disabled' : ''}>Beli (Rp ${trap.price})</button>`;
                }
                card.innerHTML = `<div class="catalog-icon">🥅</div>` + name + level + `<div class="catalog-button-group">${buttons}</div>`;
                shopContent.appendChild(card);
            }
            // Render Tools
            for (const key in gameState.tools) {
                const tool = gameState.tools[key];
                const upgradeCost = getNewUpgradeCost(tool.level + 1, tool.price);
                const card = document.createElement('div');
                card.className = 'catalog-item';
                const name = `<h3>${tool.name}</h3>`;
                const level = `<p>Level: ${tool.level}</p>`;
                let buttons = '';
                const allTrapsOwned = gameState.traps.left.owned && gameState.traps.center.owned && gameState.traps.right.owned;
                if (tool.owned) {
                    buttons = `<button class="catalog-button btn-upgrade" data-tool="${key}" ${gameState.money < upgradeCost ? 'disabled' : ''}>Upgrade (Rp ${upgradeCost})</button>`;
                } else {
                    let disabled = gameState.money < tool.price;
                    if (key === 'trapSweeper' && !allTrapsOwned) disabled = true;
                    buttons = `<button class="catalog-button btn-buy" data-tool="${key}" ${disabled ? 'disabled' : ''}>Beli (Rp ${tool.price})</button>`;
                }
                card.innerHTML = `<div class="catalog-icon">🔧</div>` + name + level + `<div class="catalog-button-group">${buttons}</div>`;
                shopToolsContent.appendChild(card);
            }
        }

        shopBtn.addEventListener('click', () => {
            pauseGame();
            renderShop();
            shopOverlay.style.display = 'flex';
        });
        
        shopContent.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button || button.disabled) return;
            const part = button.dataset.part;
            if (button.classList.contains('btn-buy')) {
                buyTrap(part);
                renderShop();
            }
            if (button.classList.contains('btn-upgrade')) {
                const trap = gameState.traps[part];
                const upgradeCost = getNewUpgradeCost(trap.level + 1, trap.price);
                if (gameState.money >= upgradeCost) {
                    gameState.money -= upgradeCost;
                    trap.level++;
                    showMessage(`Perangkap ${part} di-upgrade ke Lv. ${trap.level}!`);
                    renderShop();
                }
            }
        });

        shopToolsContent.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button || button.disabled) return;
            const key = button.dataset.tool;
            const tool = gameState.tools[key];
            if (button.classList.contains('btn-buy')) {
                if (gameState.money >= tool.price) {
                    gameState.money -= tool.price;
                    tool.owned = true;
                    tool.level = 1;
                    if (key === 'megaNet') megaNetBtn.style.display = 'block';
                    if (key === 'trapSweeper') gameState.tools.trapSweeper.position = trapPlacementHitboxes.left.x;
                    showMessage(`${tool.name} berhasil dibeli!`);
                    renderShop();
                }
            }
            if (button.classList.contains('btn-upgrade')) {
                const upgradeCost = getNewUpgradeCost(tool.level + 1, tool.price);
                if (gameState.money >= upgradeCost) {
                    gameState.money -= upgradeCost;
                    tool.level++;
                    if (key === 'megaNet') tool.cooldown -= 1;
                    showMessage(`${tool.name} di-upgrade ke Lv. ${tool.level}!`);
                    renderShop();
                }
            }
        });

        function renderInventory() {
            inventoryContent.innerHTML = '';
            let hasItems = false;
            ['specialX', 'specialY', 'specialZ'].forEach(itemKey => {
                const count = gameState.inventory[itemKey];
                const itemInfo = TRASH_TYPES[itemKey];
                hasItems = hasItems || count > 0;
                const card = document.createElement('div');
                card.className = 'catalog-item';
                const name = `<h3>${itemInfo.name}</h3>`;
                const countText = `<p>Jumlah: ${count}</p>`;
                let sellButton = '';
                if (itemInfo.sellPrice > 0) {
                    sellButton = `<button class="inventory-sell-btn" data-item="${itemKey}" ${count === 0 ? 'disabled' : ''}>Jual (Rp ${itemInfo.sellPrice})</button>`;
                } else {
                    sellButton = `<button class="inventory-sell-btn" disabled>Tidak bisa dijual</button>`;
                }
                card.innerHTML = `<div class="catalog-icon">${itemInfo.char}</div>` + name + countText + sellButton;
                inventoryContent.appendChild(card);
            });
            if (!hasItems) {
                inventoryContent.innerHTML = '<p>Kosong</p>';
            }
        }

        inventoryBtn.addEventListener('click', () => {
            pauseGame();
            renderInventory();
            inventoryOverlay.style.display = 'flex';
        });
        
        inventoryContent.addEventListener('click', (e) => {
            const button = e.target.closest('button.inventory-sell-btn');
            if (button && !button.disabled) {
                const itemKey = button.dataset.item;
                if (gameState.inventory[itemKey] > 0) {
                    const itemInfo = TRASH_TYPES[itemKey];
                    gameState.inventory[itemKey]--;
                    gameState.money += itemInfo.sellPrice;
                    showMessage(`Berhasil menjual 1 ${itemInfo.name}!`);
                    renderInventory();
                }
            }
        });
        
        megaNetBtn.addEventListener('click', () => {
            if (!megaNetBtn.disabled) {
                gameState.isUsingMegaNet = true;
                canvas.style.cursor = 'crosshair';
            }
        });
        
        pauseBtn.addEventListener('click', () => {
            pauseGame();
            pauseMenuOverlay.style.display = 'flex';
        });
        resumeBtn.addEventListener('click', resumeGame);
        restartBtn.addEventListener('click', () => window.location.reload());
        closeShopBtn.addEventListener('click', resumeGame);
        closeInventoryBtn.addEventListener('click', resumeGame);

        window.onload = function() {
            resizeCanvas();
            adjustForMobile();
            
            // Prevent default touch behaviors on mobile
            document.addEventListener('touchstart', function(e) {
                if (e.target === canvas || e.target.classList.contains('bin-button')) {
                    e.preventDefault();
                }
            }, { passive: false });

            document.addEventListener('touchmove', function(e) {
                if (e.target === canvas || gameState.isDragging) {
                    e.preventDefault();
                }
            }, { passive: false });

            document.addEventListener('touchend', function(e) {
                if (e.target === canvas || gameState.isDragging) {
                    e.preventDefault();
                }
            }, { passive: false });

            // Prevent context menu on long press
            canvas.addEventListener('contextmenu', function(e) {
                e.preventDefault();
            });

            gameLoop();
        };
    </script>
</body>
</html>
