<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Pilah Sampah</title>
    <style>
        /* Gaya dasar untuk body dan container game */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f0f0;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden; /* Mencegah scroll */
        }

        /* Container untuk kanvas game (75% tinggi layar) */
        .game-canvas-container {
            position: relative; /* Diperlukan untuk positioning tombol pause */
            width: 100%;
            height: 75vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #fff;
            border-bottom: 2px solid #ccc;
        }

        /* Gaya untuk kanvas game */
        #gameCanvas {
            border-radius: 10px;
            background-color: #a4d2e1; /* Warna air sungai */
            border: 5px solid #6b4d3e; /* Warna daratan/tepi sungai */
            box-sizing: border-box;
            width: 90%;
            height: 95%;
            cursor: pointer;
        }
        
        /* Container untuk UI di bagian bawah (25% tinggi layar) */
        .bottom-ui-container {
            width: 100%;
            height: 25vh;
            background-color: #fafafa;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 10px 20px;
            box-sizing: border-box;
        }

        /* Gaya untuk panel UI di bagian bawah */
        .ui-panel {
            display: flex;
            flex-direction: row;
            justify-content: space-between; /* Memisahkan 3 panel secara merata */
            align-items: flex-start;
            width: 100%;
            height: 100%;
        }

        .stats-container, .actions-container, .bins-container {
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 10px;
            height: 90%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.05);
            margin: 0 10px;
            flex: 1; /* Agar setiap panel mengisi ruang secara merata */
        }
        
        /* Penyesuaian lebar panel */
        .stats-container { max-width: 30%; }
        .bins-container { max-width: 35%; }
        .actions-container { max-width: 30%; }

        .ui-panel h2 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #333;
            text-align: center;
            font-size: 1.2em;
        }

        .stat-item {
            font-size: 0.9em; /* Ukuran font diperkecil agar muat */
            margin-bottom: 4px;
            padding: 4px;
            background-color: #f9f9f9;
            border-radius: 5px;
            border-left: 3px solid #007bff;
            width: 100%;
            box-sizing: border-box;
        }
        
        .stat-item.money { border-color: #28a745; }
        .stat-item.durability { border-color: #ffc107; }
        .stat-item.grab-level { border-color: #9c27b0; } /* Warna untuk level grab */

        .actions-container button {
            width: 100%;
            padding: 8px 10px;
            margin-bottom: 5px;
            font-size: 0.9em;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            color: #fff;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .actions-container button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
        }
        
        .actions-container button:disabled {
            background-color: #9e9e9e;
            cursor: not-allowed;
        }

        .btn-sell { background-color: #28a745; }
        .btn-buy-trap { background-color: #007bff; }
        .btn-maintain-trap { background-color: #ffc107; }
        .btn-upgrade-grab { background-color: #9c27b0; } /* Warna tombol upgrade */

        /* Pengaturan baru untuk container keranjang sampah */
        .bins-container {
            flex-direction: row; /* Tong sampah disusun horizontal */
            justify-content: center;
            align-items: center;
            gap: 20px; /* Jarak antar tong sampah diperbesar */
            height: 100%;
        }
        
        .bin-button {
            height: 90%; /* Memenuhi tinggi kontainer */
            aspect-ratio: 4 / 5; /* Menjaga rasio lebar:tinggi */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin: 0;
            font-size: 1.3em;
            border: none;
            border-radius: 12px;
            color: #fff;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .bin-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
        }

        .bin-organik { background-color: #4caf50; }
        .bin-anorganik { background-color: #795548; }

        .bin-button.highlight {
            box-shadow: 0 0 15px 5px rgba(255, 215, 0, 0.9); /* Efek highlight lebih jelas */
            transform: scale(1.1);
        }

        /* Elemen sampah yang diseret */
        #draggedTrash {
            position: absolute;
            width: 60px; /* Diperbesar agar muat tulisan stack */
            height: 60px;
            border-radius: 8px;
            display: none; /* Sembunyi secara default */
            pointer-events: none; /* Agar tidak mengganggu event mouse di bawahnya */
            z-index: 9999; /* Selalu di atas */
            color: white;
            font-weight: bold;
            font-size: 20px;
            text-align: center;
            line-height: 60px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
            text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
        }

        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .overlay-box {
            background-color: #fff;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .overlay-box h1 {
            margin-top: 0;
            color: #333;
        }
        
        .overlay-box .game-over-title { color: #dc3545; }

        .overlay-box button {
            padding: 12px 25px;
            font-size: 1.2em;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            color: #fff;
            font-weight: bold;
            transition: background-color 0.2s;
        }

        #resumeBtn { background-color: #28a745; }
        #resumeBtn:hover { background-color: #218838; }
        
        #restartBtn { background-color: #007bff; }
        #restartBtn:hover { background-color: #0056b3; }
        
        .btn-placeholder {
            background-color: #9e9e9e;
            cursor: not-allowed;
        }
        
        #pauseBtn {
            position: absolute;
            top: 20px;
            right: 30px;
            width: 50px;
            height: 50px;
            font-size: 24px;
            font-weight: bold;
            color: #fff;
            background-color: rgba(0, 0, 0, 0.5);
            border: 2px solid #fff;
            border-radius: 50%;
            cursor: pointer;
            z-index: 50;
            transition: background-color 0.3s;
        }
        #pauseBtn:hover {
            background-color: rgba(0, 0, 0, 0.8);
        }
        
        .message-box {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0,0,0,0.8);
            color: #fff;
            padding: 12px 24px;
            border-radius: 20px;
            opacity: 0;
            transition: opacity 0.5s ease-in-out, top 0.5s ease-in-out;
            z-index: 200;
        }

        .message-box.show {
            opacity: 1;
            top: 30px;
        }
    </style>
</head>
<body>

    <div class="game-canvas-container">
        <canvas id="gameCanvas"></canvas>
        <button id="pauseBtn">||</button>
    </div>

    <!-- Elemen untuk sampah yang diseret -->
    <div id="draggedTrash"></div>

    <div class="bottom-ui-container">
        <div class="ui-panel">
            <div class="stats-container">
                <h2>Status Game</h2>
                <div class="stat-item">Skor: <span id="score">0</span></div>
                <div class="stat-item money">Uang: Rp <span id="money">0</span></div>
                <div class="stat-item">Sampah Terlewat: <span id="lewat">0</span> / 10</div>
                <div class="stat-item durability">Durabilitas Perangkap: <span id="trapDurability">N/A</span></div>
                <div class="stat-item">Kecepatan Sampah: <span id="trashSpeed">1.0</span>x</div>
                <div class="stat-item grab-level">Area Grab: Lv. <span id="grabLevel">1</span></div>
            </div>

            <!-- Kontainer keranjang sampah baru -->
            <div class="bins-container">
                <button class="bin-button bin-organik" id="bin-organik">Organik</button>
                <button class="bin-button bin-anorganik" id="bin-anorganik">Anorganik</button>
            </div>
            
            <div class="actions-container">
                <h2>Aksi</h2>
                <button class="btn-sell" id="sellBtn">Jual Sampah (Rp 0)</button>
                <button class="btn-buy-trap" id="buyTrapBtn">Beli Perangkap (Rp 500)</button>
                <button class="btn-maintain-trap" id="maintainTrapBtn">Maintenance (Rp 250)</button>
                <button class="btn-upgrade-grab" id="upgradeGrabBtn">Upgrade Area Grab (Rp 1000)</button>
            </div>
        </div>
    </div>

    <!-- Message Box -->
    <div id="messageBox" class="message-box"></div>

    <!-- Game Over Overlay -->
    <div class="overlay" id="gameOverOverlay">
        <div class="overlay-box">
            <h1 class="game-over-title">GAME OVER!</h1>
            <p>10 sampah telah terlewat.</p>
            <p>Skor Akhir: <span id="finalScore">0</span></p>
            <button id="restartBtn">Mulai Ulang</button>
        </div>
    </div>
    
    <!-- Pause Menu Overlay -->
    <div class="overlay" id="pauseMenuOverlay">
        <div class="overlay-box">
            <h1>Game Dijeda</h1>
            <button id="resumeBtn">Lanjutkan</button>
            <button class="btn-placeholder" disabled>Coming Soon</button>
            <button class="btn-placeholder" disabled>Coming Soon</button>
        </div>
    </div>


    <script>
        // Mendapatkan elemen canvas dan konteks 2D
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let animationFrameId;

        // Definisi variabel game
        let gameState = {
            score: 0,
            money: 0,
            trashPassed: 0,
            isGameOver: false,
            isPaused: false, // Status pause baru
            trashOnScreen: [],
            trashInTrap: [],
            isTrapOwned: false,
            trapDurability: 0,
            isTrapBroken: false,
            trashSpeedMultiplier: 1.0,
            selectedTrashStack: [],
            isDragging: false,
            collectedTrash: {
                organik: [],
                plastik: [],
                kertas: [],
                kaca: [],
                logam: []
            },
            grabLevel: 1,
            grabRadius: 75,
            grabUpgradeCost: 1000,
        };

        // Data karakteristik sampah baru
        const TRASH_TYPES = {
            organik: { jenis: 'organik', kategori: 'organik', harga_per_kg: 20, damage_perangkap: 0.2, berat_kg: 0.2, kecepatan_dasar_multiplier: 0.8, color: '#8bc34a' },
            plastik: { jenis: 'plastik', kategori: 'anorganik', harga_per_kg: 50, damage_perangkap: 1, berat_kg: 0.1, kecepatan_dasar_multiplier: 1.0, color: '#ff5722' },
            kertas: { jenis: 'kertas', kategori: 'anorganik', harga_per_kg: 30, damage_perangkap: 0.5, berat_kg: 0.05, kecepatan_dasar_multiplier: 1.1, color: '#2196f3' },
            kaca: { jenis: 'kaca', kategori: 'anorganik', harga_per_kg: 40, damage_perangkap: 3, berat_kg: 0.7, kecepatan_dasar_multiplier: 0.9, color: '#e0e0e0' },
            logam: { jenis: 'logam', kategori: 'anorganik', harga_per_kg: 100, damage_perangkap: 2, berat_kg: 0.5, kecepatan_dasar_multiplier: 0.7, color: '#607d8b' }
        };

        const config = {
            trashSpawnInterval: 1500,
            trashBaseSpeed: 1.2, // Kecepatan dasar sedikit dinaikkan
            trapMaxDurability: 100,
            buyTrapCost: 500,
            maintainTrapCost: 250
        };

        let lastTrashSpawnTime = 0;

        // Mendapatkan elemen UI
        const scoreEl = document.getElementById('score');
        const moneyEl = document.getElementById('money');
        const lewatEl = document.getElementById('lewat');
        const trapDurabilityEl = document.getElementById('trapDurability');
        const trashSpeedEl = document.getElementById('trashSpeed');
        const sellBtn = document.getElementById('sellBtn');
        const buyTrapBtn = document.getElementById('buyTrapBtn');
        const maintainTrapBtn = document.getElementById('maintainTrapBtn');
        const gameOverOverlay = document.getElementById('gameOverOverlay');
        const finalScoreEl = document.getElementById('finalScore');
        const binButtons = {
            organik: document.getElementById('bin-organik'),
            anorganik: document.getElementById('bin-anorganik')
        };
        const messageBox = document.getElementById('messageBox');
        const draggedTrashEl = document.getElementById('draggedTrash');
        const grabLevelEl = document.getElementById('grabLevel');
        const upgradeGrabBtn = document.getElementById('upgradeGrabBtn');
        // Elemen baru untuk pause
        const pauseBtn = document.getElementById('pauseBtn');
        const pauseMenuOverlay = document.getElementById('pauseMenuOverlay');
        const resumeBtn = document.getElementById('resumeBtn');
        const restartBtn = document.getElementById('restartBtn');


        // Class untuk objek sampah
        class Sampah {
            constructor(type, x, y) {
                this.type = type;
                this.x = x;
                this.y = y;
                this.width = 50; // Ukuran diperbesar
                this.height = 50; // Ukuran diperbesar
                this.baseSpeed = config.trashBaseSpeed * this.type.kecepatan_dasar_multiplier;
                this.color = this.type.color;
                this.id = Math.random();
                this.isVisible = true;
            }

            draw() {
                if (!this.isVisible) return;
                ctx.fillStyle = this.color;
                ctx.fillRect(this.x, this.y, this.width, this.height);
                
                ctx.fillStyle = (this.type.jenis === 'kaca') ? '#000' : '#fff';
                ctx.font = 'bold 24px Segoe UI';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(this.type.jenis.charAt(0).toUpperCase(), this.x + this.width / 2, this.y + this.height / 2 + 2);
            }

            update(multiplier) {
                this.y += this.baseSpeed * multiplier;
            }
        }

        function showMessage(message, duration = 3000) {
            messageBox.innerText = message;
            messageBox.classList.add('show');
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, duration);
        }

        function resizeCanvas() {
            const container = canvas.parentElement;
            canvas.width = container.clientWidth * 0.9;
            canvas.height = container.clientHeight * 0.95;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        function drawBackground() {
            ctx.fillStyle = '#6b4d3e';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const riverWidth = canvas.width / 2;
            const riverStartX = (canvas.width - riverWidth) / 2;
            ctx.fillStyle = '#a4d2e1';
            ctx.fillRect(riverStartX, 0, riverWidth, canvas.height);
            
            if (gameState.isTrapOwned) {
                ctx.fillStyle = gameState.isTrapBroken ? 'rgba(255, 0, 0, 0.6)' : 'rgba(255, 255, 255, 0.6)';
                ctx.fillRect(riverStartX, canvas.height - 100, riverWidth, 15);
            }
        }

        function update() {
            gameState.trashSpeedMultiplier = 1.0 + Math.floor(gameState.score / 100) * 0.1;
            gameState.trashOnScreen.forEach(trash => trash.update(gameState.trashSpeedMultiplier));
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawBackground();
            gameState.trashOnScreen.forEach(trash => trash.draw());
            gameState.trashInTrap.forEach(trash => trash.draw());
        }
        
        // Fungsi baru untuk pause dan resume
        function pauseGame() {
            if (gameState.isGameOver) return;
            gameState.isPaused = true;
            pauseMenuOverlay.style.display = 'flex';
            cancelAnimationFrame(animationFrameId); // Hentikan loop
        }
        
        function resumeGame() {
            if (gameState.isGameOver) return;
            gameState.isPaused = false;
            pauseMenuOverlay.style.display = 'none';
            animationFrameId = requestAnimationFrame(gameLoop); // Lanjutkan loop
        }


        function gameLoop() {
            if (gameState.isGameOver || gameState.isPaused) {
                cancelAnimationFrame(animationFrameId);
                return;
            }

            const now = Date.now();
            if (now - lastTrashSpawnTime > config.trashSpawnInterval) {
                spawnTrash();
                lastTrashSpawnTime = now;
            }

            update();
            draw();
            handleGameLogic();
            updateUI();

            animationFrameId = requestAnimationFrame(gameLoop);
        }

        function spawnTrash() {
            const trashTypesKeys = Object.keys(TRASH_TYPES);
            const randomTypeKey = trashTypesKeys[Math.floor(Math.random() * trashTypesKeys.length)];
            const trashType = TRASH_TYPES[randomTypeKey];

            const riverWidth = canvas.width / 2;
            const riverStartX = (canvas.width - riverWidth) / 2;
            const x = riverStartX + Math.random() * (riverWidth - 50);

            const newTrash = new Sampah(trashType, x, -60);
            gameState.trashOnScreen.push(newTrash);
        }

        function handleGameLogic() {
            if (gameState.isTrapBroken && gameState.trashInTrap.length > 0) {
                gameState.trashInTrap.forEach(trash => gameState.trashOnScreen.push(trash));
                gameState.trashInTrap = [];
                showMessage("Sampah dari perangkap rusak terlepas!");
            }

            gameState.trashOnScreen = gameState.trashOnScreen.filter(trash => {
                if (trash.y > canvas.height) {
                    gameState.trashPassed++;
                    return false;
                }
                
                if (gameState.isTrapOwned && !gameState.isTrapBroken && trash.y + trash.height >= canvas.height - 100) {
                    gameState.trashInTrap.push(trash);
                    gameState.trapDurability -= trash.type.damage_perangkap;
                    if (gameState.trapDurability <= 0) {
                        gameState.isTrapBroken = true;
                        gameState.trapDurability = 0;
                        showMessage("Perangkap sampah rusak!");
                    }
                    return false;
                }
                
                return true;
            });
            
            if (gameState.trashPassed >= 10) {
                gameState.isGameOver = true;
                gameOverOverlay.style.display = 'flex';
                finalScoreEl.innerText = gameState.score;
            }
        }

        function updateUI() {
            scoreEl.innerText = gameState.score;
            moneyEl.innerText = gameState.money;
            lewatEl.innerText = `${gameState.trashPassed} / 10`;
            trashSpeedEl.innerText = gameState.trashSpeedMultiplier.toFixed(1) + 'x';
            trapDurabilityEl.innerText = gameState.isTrapOwned ? `${Math.max(0, Math.round(gameState.trapDurability))} / ${config.trapMaxDurability}` : 'N/A';
            
            let totalSellPrice = 0;
            for (const type in gameState.collectedTrash) {
                gameState.collectedTrash[type].forEach(trash => {
                    totalSellPrice += trash.type.harga_per_kg * trash.type.berat_kg;
                });
            }
            sellBtn.innerText = `Jual Sampah (Rp ${Math.round(totalSellPrice)})`;
            sellBtn.disabled = totalSellPrice === 0;

            buyTrapBtn.disabled = gameState.isTrapOwned || gameState.money < config.buyTrapCost;
            maintainTrapBtn.disabled = !gameState.isTrapOwned || (!gameState.isTrapBroken && gameState.trapDurability >= config.trapMaxDurability) || gameState.money < config.maintainTrapCost;
        
            grabLevelEl.innerText = gameState.grabLevel;
            upgradeGrabBtn.innerText = `Upgrade Area Grab (Rp ${gameState.grabUpgradeCost})`;
            upgradeGrabBtn.disabled = gameState.money < gameState.grabUpgradeCost;
        }
        
        function getDistance(trash1, trash2) {
            const dx = (trash1.x + trash1.width / 2) - (trash2.x + trash2.width / 2);
            const dy = (trash1.y + trash1.height / 2) - (trash2.y + trash2.height / 2);
            return Math.sqrt(dx * dx + dy * dy);
        }

        canvas.addEventListener('mousedown', (e) => {
            if (gameState.isDragging || gameState.isPaused || gameState.isGameOver) return;

            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;

            const grabbableTrash = [...gameState.trashOnScreen, ...gameState.trashInTrap];
            const clickedTrash = [...grabbableTrash].reverse().find(trash => 
                trash.isVisible &&
                mouseX >= trash.x && mouseX <= trash.x + trash.width &&
                mouseY >= trash.y && mouseY <= trash.y + trash.height
            );

            if (clickedTrash) {
                gameState.isDragging = true;
                gameState.selectedTrashStack = [clickedTrash];
                clickedTrash.isVisible = false;

                grabbableTrash.forEach(otherTrash => {
                    if (otherTrash.id !== clickedTrash.id && otherTrash.isVisible && otherTrash.type.jenis === clickedTrash.type.jenis && getDistance(clickedTrash, otherTrash) <= gameState.grabRadius) {
                        gameState.selectedTrashStack.push(otherTrash);
                        otherTrash.isVisible = false;
                    }
                });

                draw();

                const stackSize = gameState.selectedTrashStack.length;
                draggedTrashEl.style.backgroundColor = clickedTrash.color;
                draggedTrashEl.style.color = (clickedTrash.type.jenis === 'kaca') ? '#000' : '#fff';
                draggedTrashEl.innerText = `${clickedTrash.type.jenis.charAt(0).toUpperCase()} x${stackSize}`;
                draggedTrashEl.style.left = `${e.clientX - draggedTrashEl.offsetWidth / 2}px`;
                draggedTrashEl.style.top = `${e.clientY - draggedTrashEl.offsetHeight / 2}px`;
                draggedTrashEl.style.display = 'block';
                document.body.style.cursor = 'grabbing';
            }
        });
        
        window.addEventListener('mousemove', (e) => {
            if (gameState.isDragging && gameState.selectedTrashStack.length > 0) {
                draggedTrashEl.style.left = `${e.clientX - draggedTrashEl.offsetWidth / 2}px`;
                draggedTrashEl.style.top = `${e.clientY - draggedTrashEl.offsetHeight / 2}px`;
                const draggedRect = draggedTrashEl.getBoundingClientRect();
                for (const type in binButtons) {
                    binButtons[type].classList.toggle('highlight', isOverlapping(draggedRect, binButtons[type].getBoundingClientRect()));
                }
            }
        });
        
        window.addEventListener('mouseup', (e) => {
            if (!gameState.isDragging) return;
            
            if (gameState.selectedTrashStack.length > 0) {
                 const stack = gameState.selectedTrashStack;
                const stackCategory = stack[0].type.kategori;
                let droppedOnBin = false;
                
                const draggedRect = draggedTrashEl.getBoundingClientRect();

                for (const binCategory in binButtons) {
                    const binRect = binButtons[binCategory].getBoundingClientRect();
                    if (isOverlapping(draggedRect, binRect)) {
                        droppedOnBin = true;
                        if (stackCategory === binCategory) {
                            gameState.score += 10 * stack.length;
                            stack.forEach(trash => gameState.collectedTrash[trash.type.jenis].push(trash));
                            showMessage(`+${stack.length} sampah ${stack[0].type.jenis} dikumpulkan!`, 2000);
                        } else {
                            gameState.trashPassed += stack.length;
                            showMessage(`Salah keranjang! ${stack.length} sampah terlewat.`, 2000);
                        }
                        break; 
                    }
                }
                
                const stackIds = new Set(stack.map(t => t.id));
                if (droppedOnBin) {
                    gameState.trashOnScreen = gameState.trashOnScreen.filter(t => !stackIds.has(t.id));
                    gameState.trashInTrap = gameState.trashInTrap.filter(t => !stackIds.has(t.id));
                } else {
                    const canvasRect = canvas.getBoundingClientRect();
                    stack.forEach(trash => {
                        trash.isVisible = true;
                        gameState.trashInTrap = gameState.trashInTrap.filter(t => t.id !== trash.id); 
                        
                        let newX = e.clientX - canvasRect.left - trash.width / 2;
                        let newY = e.clientY - canvasRect.top - trash.height / 2;
                        
                        trash.x = Math.max(0, Math.min(newX, canvas.width - trash.width));
                        trash.y = Math.max(0, Math.min(newY, canvas.height - trash.height));
                        
                        if (!gameState.trashOnScreen.some(t => t.id === trash.id)) {
                           gameState.trashOnScreen.push(trash);
                        }
                    });
                    showMessage(`${stack.length} sampah kembali ke sungai!`, 2000);
                }
            }

            // Reset state
            for (const type in binButtons) { binButtons[type].classList.remove('highlight'); }
            draggedTrashEl.style.display = 'none';
            document.body.style.cursor = 'default';
            gameState.isDragging = false;
            gameState.selectedTrashStack = [];
            draw();
        });

        function isOverlapping(rect1, rect2) {
            return !(rect1.right < rect2.left || rect1.left > rect2.right || rect1.bottom < rect2.top || rect1.top > rect2.bottom);
        }
        
        // Event Listeners untuk Tombol
        sellBtn.addEventListener('click', () => {
            let totalMoney = 0;
            for (const type in gameState.collectedTrash) {
                gameState.collectedTrash[type].forEach(trash => {
                    totalMoney += trash.type.harga_per_kg * trash.type.berat_kg;
                });
                gameState.collectedTrash[type] = [];
            }
            if (totalMoney > 0) {
                gameState.money += Math.round(totalMoney);
                showMessage(`Berhasil menjual sampah senilai Rp ${Math.round(totalMoney)}!`);
                updateUI();
            }
        });
        
        buyTrapBtn.addEventListener('click', () => {
            if (gameState.money >= config.buyTrapCost && !gameState.isTrapOwned) {
                gameState.money -= config.buyTrapCost;
                gameState.isTrapOwned = true;
                gameState.isTrapBroken = false;
                gameState.trapDurability = config.trapMaxDurability;
                showMessage("Perangkap sampah berhasil dibeli!");
                updateUI();
            }
        });

        maintainTrapBtn.addEventListener('click', () => {
            if (gameState.isTrapOwned && gameState.money >= config.maintainTrapCost) {
                gameState.money -= config.maintainTrapCost;
                gameState.trapDurability = config.trapMaxDurability;
                gameState.isTrapBroken = false;
                showMessage("Perangkap berhasil di-maintenance!");
                updateUI();
            }
        });

        upgradeGrabBtn.addEventListener('click', () => {
            if (gameState.money >= gameState.grabUpgradeCost) {
                gameState.money -= gameState.grabUpgradeCost;
                gameState.grabLevel++;
                gameState.grabRadius += 25;
                gameState.grabUpgradeCost = Math.round(gameState.grabUpgradeCost * 2.5);
                showMessage(`Area Grab di-upgrade ke Lv. ${gameState.grabLevel}!`);
                updateUI();
            }
        });
        
        pauseBtn.addEventListener('click', pauseGame);
        resumeBtn.addEventListener('click', resumeGame);
        restartBtn.addEventListener('click', () => window.location.reload());

        window.onload = function() {
            gameLoop();
        };
    </script>
</body>
</html>
